---
config:
  theme: redux-color
---
erDiagram
    %% ========================================
    %% SINGLE FACT TABLE (GRAIN: Order Line Item per Shipment)
    %% Schema: BL_DM
    %% ========================================

    FCT_ORDER_LINE_SHIPMENTS_DD {
        BIGINT ORDER_LINE_SHIPMENT_SURR_ID PK "NOT NULL, SEQUENCE"

        DATE EVENT_DT "NOT NULL - Main time key, date of event"

        %% Dimension Foreign Keys
        BIGINT CUSTOMER_SURR_ID FK "NOT NULL"
        BIGINT PRODUCT_SURR_ID FK "NOT NULL"
        BIGINT SALES_REP_SURR_ID FK "NOT NULL"
        BIGINT ORDER_DT_SURR_ID FK "NOT NULL"
        BIGINT SHIP_DT_SURR_ID FK "NOT NULL"
        BIGINT DELIVERY_DT_SURR_ID FK "NULL"
        BIGINT CUSTOMER_GEOGRAPHY_SURR_ID FK "NOT NULL"
        BIGINT WAREHOUSE_SURR_ID FK "NOT NULL"
        BIGINT CARRIER_SURR_ID FK "NOT NULL"
        BIGINT PAYMENT_METHOD_SURR_ID FK "NOT NULL"
        BIGINT ORDER_STATUS_SURR_ID FK "NOT NULL"
        BIGINT SHIPPING_MODE_SURR_ID FK "NOT NULL"
        BIGINT DELIVERY_STATUS_SURR_ID FK "NOT NULL"

        %% Degenerate Dimensions (Natural Keys)
        BIGINT ORDER_SRC_ID "NOT NULL"
        BIGINT ORDER_LINE_SRC_ID "NOT NULL"
        BIGINT SHIPMENT_SRC_ID "NOT NULL"
        BIGINT SHIPMENT_LINE_SRC_ID "NOT NULL"
        BIGINT DELIVERY_SRC_ID "NULL"

        %% Sales Measures
        DECIMAL UNIT_PRICE_ACT "NOT NULL, DECIMAL(15,2)"
        DECIMAL UNIT_COST_ACT "NULL, DECIMAL(15,2)"
        DECIMAL LINE_TOTAL_ACT "NOT NULL, DECIMAL(15,2)"
        INTEGER ORDERED_QUANTITY_CNT "NOT NULL"
        DECIMAL ORDER_PROFIT_ACT "NULL, DECIMAL(15,2)"

        %% Shipment Measures
        INTEGER SHIPPED_QUANTITY_CNT "NOT NULL"
        DECIMAL SHIPPING_COST_ACT "NULL, DECIMAL(15,2)"
        DECIMAL ALLOCATED_SHIPPING_COST_ACT "NULL, DECIMAL(15,2)"

        %% Delivery Measures
        INTEGER DELIVERY_DAYS_CNT "NULL"
%%        INTEGER PLANNED_DELIVERY_DAYS_CNT "NULL" %% not avaliabledata from source
        INTEGER ORDER_TO_SHIP_DAYS_CNT "NULL"
        DECIMAL ON_TIME_DELIVERY_FLAG "NULL, DECIMAL(1,0)"
        DECIMAL LATE_DELIVERY_FLAG "NULL, DECIMAL(1,0)"

        %% Calculated Measures
        DECIMAL SHIPPED_SALES_AMOUNT_ACT "NOT NULL, DECIMAL(15,2)"
        DECIMAL UNSHIPPED_QUANTITY_CNT "NOT NULL, DECIMAL(10,2)"
        DECIMAL FILL_RATE_PCT "NULL, DECIMAL(5,2)"

        %% Technical Attributes
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    %% ========================================
    %% SCD TYPE 2 DIMENSIONS
    %% ========================================

    DIM_PRODUCTS_SCD {
        BIGINT PRODUCT_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT PRODUCT_SRC_ID "NOT NULL"
        VARCHAR PRODUCT_NAME "NOT NULL, VARCHAR(255)"
        VARCHAR BRAND_NAME "NOT NULL, VARCHAR(100)"
        BIGINT BRAND_SRC_ID "NOT NULL"
        BIGINT PRIMARY_CATEGORY_SRC_ID "NOT NULL"
        VARCHAR PRIMARY_CATEGORY_NAME "NOT NULL, VARCHAR(100)"
        BIGINT DEPARTMENT_SRC_ID "NOT NULL"
        VARCHAR DEPARTMENT_NAME "NOT NULL, VARCHAR(100)"
        TEXT ALL_CATEGORY_SRC_IDS "NULL - Pipe delimited"
        TEXT ALL_CATEGORY_NAMES "NULL - Pipe delimited"
        VARCHAR PRODUCT_STATUS_NAME "NOT NULL, VARCHAR(50)"
        BIGINT PRODUCT_STATUS_SRC_ID "NOT NULL"
        DATE START_DT "NOT NULL, DEFAULT '1990-01-01'"
        DATE END_DT "NOT NULL, DEFAULT '9999-12-31'"
        VARCHAR IS_ACTIVE "NOT NULL, VARCHAR(1), DEFAULT 'Y'"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    %% ========================================
    %% SCD TYPE 1 DIMENSIONS
    %% ========================================

    DIM_CUSTOMERS{
        BIGINT CUSTOMER_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT CUSTOMER_SRC_ID "NOT NULL"
        VARCHAR CUSTOMER_FIRST_NAME "NOT NULL, VARCHAR(100)"
        VARCHAR CUSTOMER_LAST_NAME "NOT NULL, VARCHAR(100)"
        VARCHAR CUSTOMER_FULL_NAME "NOT NULL, VARCHAR(200)"
        VARCHAR CUSTOMER_GENDER "NOT NULL, VARCHAR(10)"
        INTEGER CUSTOMER_YEAR_OF_BIRTH "NOT NULL"
        VARCHAR CUSTOMER_EMAIL "NOT NULL, VARCHAR(255)"
        VARCHAR CUSTOMER_SEGMENT "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_GEOGRAPHIES {
        BIGINT GEOGRAPHY_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT GEOGRAPHY_SRC_ID "NOT NULL"
        VARCHAR CITY_NAME "NOT NULL, VARCHAR(100)"
        BIGINT CITY_SRC_ID "NOT NULL"
        VARCHAR STATE_NAME "NOT NULL, VARCHAR(100)"
        BIGINT STATE_SRC_ID "NOT NULL"
        VARCHAR STATE_CODE "NULL, VARCHAR(10)"
        VARCHAR COUNTRY_NAME "NOT NULL, VARCHAR(100)"
        BIGINT COUNTRY_SRC_ID "NOT NULL"
        VARCHAR COUNTRY_CODE "NULL, VARCHAR(10)"
        VARCHAR REGION_NAME "NOT NULL, VARCHAR(100)"
        BIGINT REGION_SRC_ID "NOT NULL"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_SALES_REPRESENTATIVES {
        BIGINT SALES_REP_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT SALES_REP_SRC_ID "NOT NULL"
        VARCHAR SALES_REP_NAME "NOT NULL, VARCHAR(100)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_WAREHOUSES {
        BIGINT WAREHOUSE_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT WAREHOUSE_SRC_ID "NOT NULL"
        VARCHAR WAREHOUSE_NAME "NOT NULL, VARCHAR(100)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_CARRIERS {
        BIGINT CARRIER_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT CARRIER_SRC_ID "NOT NULL"
        VARCHAR CARRIER_NAME "NOT NULL, VARCHAR(100)"
        VARCHAR CARRIER_TYPE "NULL, VARCHAR(50)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_ORDER_STATUSES {
        BIGINT ORDER_STATUS_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT ORDER_STATUS_SRC_ID "NOT NULL"
        VARCHAR ORDER_STATUS "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_PAYMENT_METHODS {
        BIGINT PAYMENT_METHOD_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT PAYMENT_METHOD_SRC_ID "NOT NULL"
        VARCHAR PAYMENT_METHOD "NOT NULL, VARCHAR(100)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_SHIPPING_MODES {
        BIGINT SHIPPING_MODE_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT SHIPPING_MODE_SRC_ID "NOT NULL"
        VARCHAR SHIPPING_MODE "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    DIM_DELIVERY_STATUSES {
        BIGINT DELIVERY_STATUS_SURR_ID PK "NOT NULL, SEQUENCE"
        BIGINT DELIVERY_STATUS_SRC_ID "NOT NULL"
        VARCHAR DELIVERY_STATUS "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50)"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(100)"
        TIMESTAMP TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
        TIMESTAMP TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_TIMESTAMP"
    }

    %% ========================================
    %% CALENDAR DIMENSION (Single Time Dimension)
    %% ========================================

    DIM_TIME_DAY {
        BIGINT DT_SURR_ID PK "NOT NULL"
        DATE CALENDAR_DT "NOT NULL UNIQUE"
        INTEGER YEAR_NUM "NOT NULL"
        INTEGER QUARTER_NUM "NOT NULL"
        INTEGER MONTH_NUM "NOT NULL"
        INTEGER WEEK_NUM "NOT NULL"
        INTEGER DAY_NUM "NOT NULL"
        INTEGER DAY_OF_YEAR_NUM "NOT NULL"
        INTEGER DAY_OF_WEEK_NUM "NOT NULL"
        VARCHAR MONTH_NAME "NOT NULL, VARCHAR(20)"
        VARCHAR MONTH_NAME_SHORT "NOT NULL, VARCHAR(3)"
        VARCHAR DAY_NAME "NOT NULL, VARCHAR(20)"
        VARCHAR DAY_NAME_SHORT "NOT NULL, VARCHAR(3)"
        VARCHAR QUARTER_NAME "NOT NULL, VARCHAR(10)"
        VARCHAR YEAR_QUARTER "NOT NULL, VARCHAR(10)"
        VARCHAR YEAR_MONTH "NOT NULL, VARCHAR(10)"
        BOOLEAN IS_WEEKEND "NOT NULL"
        BOOLEAN IS_HOLIDAY "NOT NULL"
        VARCHAR HOLIDAY_NAME "NULL, VARCHAR(100)"
        VARCHAR SOURCE_SYSTEM "NOT NULL, VARCHAR(50), DEFAULT 'SYSTEM'"
        VARCHAR SOURCE_ENTITY "NOT NULL, VARCHAR(50), DEFAULT 'DATE_GENERATOR'"
        DATE TA_INSERT_DT "NOT NULL, DEFAULT CURRENT_DATE"
        DATE TA_UPDATE_DT "NOT NULL, DEFAULT CURRENT_DATE"
    }

    %% ========================================
    %% STAR SCHEMA RELATIONSHIPS
    %% ========================================

    %% NOTE: SCD2 Product relationship is enforced logically in ETL, not as FK constraint
    DIM_PRODUCTS_SCD ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "Logical FK(PRODUCT_SURR_ID) with time validation"

    %% SCD1 RELATIONSHIPS (STANDARD FK CONSTRAINTS)
    DIM_CUSTOMERS ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(CUSTOMER_SURR_ID)"
    DIM_SALES_REPRESENTATIVES ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(SALES_REP_SURR_ID)"
    DIM_GEOGRAPHIES ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(CUSTOMER_GEOGRAPHY_SURR_ID)"
    DIM_WAREHOUSES ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(WAREHOUSE_SURR_ID)"
    DIM_CARRIERS ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(CARRIER_SURR_ID)"
    DIM_PAYMENT_METHODS ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(PAYMENT_METHOD_SURR_ID)"
    DIM_ORDER_STATUSES ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(ORDER_STATUS_SURR_ID)"
    DIM_SHIPPING_MODES ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(SHIPPING_MODE_SURR_ID)"
    DIM_DELIVERY_STATUSES ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(DELIVERY_STATUS_SURR_ID)"

    %% TIME DIMENSION RELATIONSHIPS (ROLE-PLAYING)
    DIM_TIME_DAY ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(ORDER_DT_SURR_ID)"
    DIM_TIME_DAY ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(SHIP_DT_SURR_ID)"
    DIM_TIME_DAY ||--o{ FCT_ORDER_LINE_SHIPMENTS_DD : "FK(DELIVERY_DT_SURR_ID)"